{
  "nodes": [
    {
      "parameters": {
        "operation": "text",
        "options": {}
      },
      "id": "e43b2a6c-e505-4aae-9e6c-569a8daa664a",
      "name": "Extract Document Text",
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        960,
        2064
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "id": "35f5f931-df7d-4877-b610-86e18e73fd09",
      "name": "Extract PDF Text",
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        1024,
        1568
      ]
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "id": "0271591b-c254-4ac2-9e82-f7027402c843",
      "name": "Aggregate",
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        1184,
        2208
      ]
    },
    {
      "parameters": {
        "fieldsToSummarize": {
          "values": [
            {
              "aggregation": "concatenate",
              "field": "data"
            }
          ]
        },
        "options": {}
      },
      "id": "89f65d30-ae54-404a-b662-515963bea661",
      "name": "Summarize",
      "type": "n8n-nodes-base.summarize",
      "typeVersion": 1,
      "position": [
        1408,
        2208
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "e3a4d243-5c9e-4363-aeda-4afe1afab79e",
                    "leftValue": "={{ $binary.values()[0].mimeType }}",
                    "rightValue": "image/jpeg",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $binary.values()[0].mimeType }}",
                    "rightValue": "application/pdf",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    },
                    "id": "59677ac7-7038-4f77-94a3-69df1b6544a2"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "d7c8331d-3ac1-43cb-9774-9f18cda2abc4",
                    "leftValue": "={{ $binary.values()[0].mimeType }}",
                    "rightValue": "application/json",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "2ae7faa7-a936-4621-a680-60c512163034",
                    "leftValue": "={{ $binary.values()[0].mimeType }}",
                    "rightValue": "application/vnd.ms-excel",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "fc193b06-363b-4699-a97d-e5a850138b0e",
                    "leftValue": "={{ $binary.values()[0].mimeType }}",
                    "rightValue": "=application/vnd.google-apps.spreadsheet",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "b69f5605-0179-4b02-9a32-e34bb085f82d",
                    "leftValue": "={{ $binary.values()[0].mimeType }}",
                    "rightValue": "application/vnd.google-apps.document",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "f30330d4-a83c-4e9e-9a0b-7de8a1767dc2",
                    "leftValue": "={{ $json.binary_files.mimeType }}",
                    "rightValue": "text/csv",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "26ad52bb-287b-4197-9d28-0878b619b93d",
      "name": "Switch",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        640,
        1552
      ]
    },
    {
      "parameters": {
        "operation": "xlsx",
        "options": {}
      },
      "id": "818b0635-2808-4e12-8f97-76f781d271bf",
      "name": "Extract from Excel",
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        960,
        2352
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        960,
        2208
      ],
      "id": "8b12ec95-ca77-48d2-ba0a-5a40cab3a016",
      "name": "Extract from CSV"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "document_rows",
          "mode": "list",
          "cachedResultName": "document_rows"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "dataset_id": "={{ $('Set File ID').item.json.file_id }}",
            "row_data": "={{ $json.toJsonString().replaceAll(/'/g, \"''\") }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "dataset_id",
              "displayName": "dataset_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_data",
              "displayName": "row_data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1184,
        2352
      ],
      "id": "f3af8a73-9896-4a21-bec2-ea7767111905",
      "name": "Insert Table Rows",
      "credentials": {
        "postgres": {
          "id": "rReqZb6H4chGQnSg",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "inputSource": "jsonExample",
        "jsonExample": "{\n  \"binary_files\": \n      {\n        \"attachment_0\": \n          {\n          \"mimeType\": \"image/jpeg\",\n          \"fileType\": \"pdf\",\n          \"fileExtension\": \"pdf\",\n          \"data\": \"%PDF-1.0\\ntrailer<</Root<</Pages<</Kids[<</MediaBox[0 0 3 3]>>]>>>>>>\",\n          \"fileName\": \"image001.jpg\",\n          \"fileSize\": \"6.68 kB\"\n            },\n            \"attachment_1\": \n            {\n            \"mimeType\": \"image/png\",\n            \"fileType\": \"image\",\n            \"fileExtension\": \"png\",\n            \"data\": \"iVBORw0KGgoAA...LVhj9+RyLCNqAoieyMiClpEFLSIiChoEVHQIv6n+GcAG8nxS438B1wAAAAASUVORK5CYII=\",\n            \"fileName\": \"image002.png\",\n            \"fileSize\": \"6.07 kB\"\n            }\n      },\n  \"data\": {\"key0\":\"val0\"},\n  \"metadata\": \n  {\n  \"file_id\": \"1968dc035a3f7f40\",\n  \"file_type\": \"gmail\",\n  \"file_title\": \"Google Cloud Platform & APIs: Your invoice is available for 01E17F-79B946-1695E2\",\n  \"file_url\": \"Null\"\n  }\n}"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        176,
        1552
      ],
      "id": "13eec4d7-0898-45bd-8f81-e40f752f8634",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d783b0b2-3058-49db-a543-0a405c5d815e",
              "name": "data",
              "value": "={{$json}}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1712,
        1568
      ],
      "id": "933985ab-2ff3-4926-b0f2-80873d6346a8",
      "name": "Return node"
    },
    {
      "parameters": {
        "jsCode": "return $input.all().flatMap(item => \n    item.binary ? Object.keys(item.binary).map(key => ({\n        json: { fileName: item.binary[key].fileName },\n        binary: { data: item.binary[key] }\n    })) : []\n);\n\n// return {\n//   json: $('Edit Fields3').item.json,\n//   binary: $('Edit Fields3').item.binary\n// };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        960,
        1824
      ],
      "id": "ae7ec905-dd0d-4e1a-9cb6-673246fb2334",
      "name": "Code"
    },
    {
      "parameters": {
        "content": "",
        "height": 200,
        "width": 460
      },
      "id": "28177613-d046-4d08-a22d-1ca6a5108f8f",
      "name": "Sticky Note2",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        0,
        1728
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "https://drive.google.com/file/d/1V4ZuvFi_c1X7jn6fGmRlZ6q_5CYTQ9G7/view?usp=drive_link",
          "mode": "url"
        },
        "options": {}
      },
      "id": "3342e90d-7f74-4254-b24b-bd4d914b8d63",
      "name": "Download File1",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        176,
        1760
      ],
      "executeOnce": true,
      "credentials": {}
    },
    {
      "parameters": {
        "content": "## Use case",
        "height": 188,
        "width": 460
      },
      "id": "99bdf819-df1e-4daa-8fc5-a6dc4cda2241",
      "name": "Sticky Note3",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        0,
        1520
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "operation": "fromJson",
        "binaryPropertyName": "=data",
        "destinationKey": "data.unpacked",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        1184,
        1824
      ],
      "id": "0b6ad33c-1131-4a70-a314-055b2e82ac75",
      "name": "Extract from File2",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "5159416e-3874-4975-b717-0da109def82e",
      "name": "Google Gemini Chat Model1",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "position": [
        1248,
        1360
      ],
      "typeVersion": 1,
      "credentials": {
        "googlePalmApi": {
          "id": "kmqRSsOartR5rGAD",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "Extract invoice data from this image.",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "=You are an Invoice Data Extractor. Given an invoice image, extract all visible information directly into a structured JSON object.\n\n**Output Requirements:**\n- Respond with ONLY the JSON object. No explanations or other text.\n- If no readable content exists, respond with: {}\n\n**Key Naming Rules:**\n1. Use `snake_case` in English\n2. Prioritize these standard keys when applicable:\n\n   *Supplier:* supplier_name, supplier_address, supplier_contact_details, supplier_tax_id, supplier_vat_number\n   *Recipient:* recipient_business_name, recipient_business_address\n   *Invoice:* invoice_number, invoice_date, purchase_order_number, internal_reference_number\n   *Payment:* due_date, payment_terms, supplier_bank_account_details, total_amount_due, currency_code, subtotal_amount, tax_amount, discount_amount\n   *Processing:* date_received, department_id, cost_center_code, approver_id, approver_name, date_paid, payment_method, payment_reference, invoice_status\n   *Other:* notes\n\n3. For labeled fields not matching standard keys, derive the key from the label (e.g., \"Invoice #:\" → `invoice_hash`)\n4. For unlabeled non-standard info, create a descriptive `snake_case` key\n5. Prefix uncertain mappings with `uncertain_`\n6. Omit keys for missing information—never invent data"
            },
            {
              "type": "HumanMessagePromptTemplate",
              "messageType": "imageBinary"
            }
          ]
        }
      },
      "id": "c0a56f13-559e-4853-b777-2e17c0eea9b1",
      "name": "Image-to-text",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "position": [
        1120,
        1200
      ],
      "typeVersion": 1.4
    },
    {
      "parameters": {
        "borderWidth": 1,
        "borderHeight": 1,
        "options": {
          "fileName": "data"
        }
      },
      "id": "e961e777-fd52-4f94-9a55-8d268fed1b49",
      "name": "conversion",
      "type": "n8n-nodes-base.editImage",
      "position": [
        928,
        1200
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "252dc06a-a11a-4bd5-b32d-18d700b2ab1c",
              "name": "text",
              "value": "={{ $json.text.replace(/^(```json\\n)?(.*?)(\\n```)?$/s, '$2')}}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1472,
        1200
      ],
      "id": "930191d8-19e3-419d-9f1b-9760562eec93",
      "name": "Edit Fields4"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "55b557f2-23ca-4c7e-b2fc-e122f91383a2",
              "name": "metadata",
              "value": "=I FACED AN ERROR",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        640,
        1904
      ],
      "id": "6d417ba4-3cf1-44df-9465-dc6aab1ee991",
      "name": "Fallback"
    },
    {
      "parameters": {
        "jsCode": "return $input.all().flatMap(item => \n    item.binary ? Object.keys(item.binary).map(key => ({\n        json: item.json, // This preserves ALL original JSON data\n        binary: { data: item.binary[key] }\n    })) : [item]\n);"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        496,
        1552
      ],
      "id": "b615ecf3-36cd-4c44-ad1b-92220006aca7",
      "name": "(File-rename)"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "0af57e1c-21ab-433b-a109-3e21070857a2",
              "name": "binary_files",
              "value": "={{ $input.item.binary.data || JSON.parse('{\\\"message\\\": \\\"No binary Attachment\\\"}') }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        336,
        1760
      ],
      "id": "e26956d1-eb46-4133-8f59-ed30b48c9375",
      "name": "Extract Binary Data"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        16,
        1760
      ],
      "id": "4b48a4e5-e6ef-443c-9c8e-a3cdafabf887",
      "name": "Testing n8n sub-workflow",
      "disabled": true
    },
    {
      "parameters": {
        "content": "## Any-file2json \n## converter",
        "height": 1392,
        "width": 1264,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        640,
        1120
      ],
      "typeVersion": 1,
      "id": "a9ffd4af-243a-41bd-ba35-6181cb044249",
      "name": "Sticky Note10"
    },
    {
      "parameters": {
        "content": "\n\n\n\n\n\n\n\n\n\n\n\nThis node requires an LLM API which accpets images. Google works nicely, leave this model if possible.",
        "height": 224,
        "width": 272,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1152,
        1344
      ],
      "id": "8af6f6d0-3f04-4fb2-9716-85cf6836f789",
      "name": "Sticky Note15"
    },
    {
      "parameters": {
        "content": "\n# · image OCR\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n```\n```\n# · pdf\n\n\n\n\n\n\n\n\n\n```\n```\n# · json\n\n\n\n\n\n\n\n\n\n```\n```\n# · csv / excel / etc.\n\n\n\n\n\n",
        "height": 1288,
        "width": 752,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        912,
        1136
      ],
      "id": "0ff0f643-cf7e-4268-b870-7944b45f4d7b",
      "name": "Sticky Note"
    }
  ],
  "connections": {
    "Extract Document Text": {
      "main": [
        [
          {
            "node": "Return node",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract PDF Text": {
      "main": [
        [
          {
            "node": "Return node",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate": {
      "main": [
        [
          {
            "node": "Summarize",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Summarize": {
      "main": [
        [
          {
            "node": "Return node",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "conversion",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract PDF Text",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract from Excel",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract from CSV",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Document Text",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract from CSV",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fallback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from Excel": {
      "main": [
        [
          {
            "node": "Aggregate",
            "type": "main",
            "index": 0
          },
          {
            "node": "Insert Table Rows",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from CSV": {
      "main": [
        [
          {
            "node": "Aggregate",
            "type": "main",
            "index": 0
          },
          {
            "node": "Insert Table Rows",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "(File-rename)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Return node": {
      "main": [
        []
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Extract from File2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download File1": {
      "main": [
        [
          {
            "node": "Extract Binary Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File2": {
      "main": [
        [
          {
            "node": "Return node",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Image-to-text",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Image-to-text": {
      "main": [
        [
          {
            "node": "Edit Fields4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "conversion": {
      "main": [
        [
          {
            "node": "Image-to-text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields4": {
      "main": [
        [
          {
            "node": "Return node",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "(File-rename)": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Binary Data": {
      "main": [
        [
          {
            "node": "(File-rename)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Testing n8n sub-workflow": {
      "main": [
        [
          {
            "node": "Download File1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {
    "When Executed by Another Workflow": [
      {
        "binary_files": null,
        "data": null,
        "metadata": null
      }
    ]
  },
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "09a80676641fdc883fcaa67648f06322bebbd00adb281b1cf481107091bcc026"
  }
}